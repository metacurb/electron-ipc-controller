<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:"
    />
    <title>Basic Example - electron-ipc-bridge</title>
    <link rel="stylesheet" href="assets/main.css" />
  </head>

  <body>
    <div class="app-container">
      <div class="text">electron-ipc-bridge demo</div>

      <div class="counter-card">
        <h2>Counter Demo</h2>
        <div class="counter-value" id="counter">...</div>

        <div class="increment-options">
          <label for="increment-by">Increment by:</label>
          <input id="increment-by" type="number" value="1" min="1" />
        </div>

        <div class="counter-actions">
          <button id="increment" disabled>Increment</button>
          <button id="reset" class="secondary" disabled>Reset</button>
        </div>
        <div class="status" id="status">Connecting...</div>
      </div>
    </div>

    <script>
      const counterEl = document.getElementById("counter");
      const statusEl = document.getElementById("status");
      const incrementBtn = document.getElementById("increment");
      const resetBtn = document.getElementById("reset");
      const incrementByInput = document.getElementById("increment-by");

      let loading = true;

      function setStatus(text, isError = false) {
        statusEl.textContent = text;
        if (isError) {
          statusEl.classList.add("error");
        } else {
          statusEl.classList.remove("error");
        }
      }

      function setLoading(isLoading) {
        loading = isLoading;
        incrementBtn.disabled = isLoading;
        resetBtn.disabled = isLoading;
      }

      // Wait for IPC API to be ready
      function waitForIpc(maxAttempts = 50) {
        return new Promise((resolve, reject) => {
          let attempts = 0;
          const check = () => {
            attempts++;
            if (window.ipc && window.ipc.counter) {
              resolve(window.ipc);
            } else if (attempts >= maxAttempts) {
              reject(new Error("IPC API not available"));
            } else {
              setTimeout(check, 100);
            }
          };
          check();
        });
      }

      async function init() {
        try {
          const ipc = await waitForIpc();

          // Test connection with typed ping
          const pong = await ipc.counter.ping();
          setStatus(`Connected! ping â†’ ${pong}`);

          // Get initial counter value
          const currentCount = await ipc.counter.get();
          counterEl.textContent = currentCount;
          setLoading(false);

          // Set up button handlers
          incrementBtn.addEventListener("click", async () => {
            try {
              const incrementBy = parseInt(incrementByInput.value) || 1;
              const newCount = await ipc.counter.inc(incrementBy);
              counterEl.textContent = newCount;
              setStatus(`Incremented by ${incrementBy} to ${newCount}`);
            } catch (err) {
              setStatus(`Error: ${err.message}`, true);
            }
          });

          resetBtn.addEventListener("click", () => {
            ipc.counter.reset();
            counterEl.textContent = "0";
            setStatus("Counter reset");
          });
        } catch (err) {
          setStatus(`Error: ${err.message}`, true);
          setLoading(false);
        }
      }

      init();
    </script>
  </body>
</html>
